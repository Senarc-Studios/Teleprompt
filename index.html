<html>
	<head>
		<title>Admin Teleprompt</title>
		<style>
			body {
				color: #FFFFFF;
				background-color: #1E1E1E;
			}
			h1 {
				font-size: 150%;
				font-weight: bold;
				text-align: center;
			}
			p {
				padding-left: 3%;
			}
			.console {
				position: fixed;
				right: 0px;
				width: 100%;
				overflow-y: auto;
			}

			.run {
				background-color: #181A1C;
				border-top-color: #FFFFFF;
				border-top-style: solid;
				border-top-width: 1px;
				border-bottom: 1px solid #181A1C;
				border-left: 1px solid #181A1C;
				border-right: 1px solid #181A1C;
				position: fixed;
				color: #FFFFFF;
				bottom: 0px;
				width: 100%;
			}
		</style>
	</head>
	<body>
		<pre id="main">
			<h1>Welcome To<br/>Teleprompt!</h1>
		</pre>
		<div class='console' height='600'>
			<input class='run' id="text-box" type='text' placeholder='Send a message.'/>
		</div>
		<script>
			const BASE_URL = "https://canary.senarc.org";
			let token = null
			let username = null

			function getInfo() {
				let responseJson = null;
				if (token === null) {
					return null;
				};
				let xhr = new XMLHttpRequest();

				xhr.open("GET", `${BASE_URL}/token/info`);
				xhr.setRequestHeader("Authorisation", token);
				xhr.send();

				xhr.onloadend = function() {
					responseJson = JSON.parse(xhr.responseText);
					if (responseJson.success) {
						username = responseJson.username;
					} else {
						token = null;
						username = null;
						print("Invalid or Corrupted Token.");
					}
				}
			};

			function print(content) {
				var tag = document.createElement("p");
				var text = document.createTextNode(content);
				tag.appendChild(text);
				var element = document.getElementById("main");
				element.appendChild(tag);
			};

			function sendMessage(message=null) {
				if (username === null) {
					return print("You must login with the following command before you can talk: !login <your-senarc-token>");
				};
				if (message === null) {
					var message = document.getElementById("text-box").value;
				};
				print(`${username}: ${message}`);
				document.getElementById("text-box").value = "";
			};

			var input = document.getElementById("text-box");

			function checkResponse(json, token_) {
				if (json['valid'] === true) {
					return true;
				} else {
					return false;
				}
				token = token_;
			};

			function validate() {
				var token_ = input.value.substr(7);

				if (input.value === "") {
					return null;
				} else if (input.value.startsWith("!login ")) {
					let xhr = new XMLHttpRequest();

					xhr.open('POST', `${BASE_URL}/token/verify`);
					xhr.setRequestHeader('Authorisation', token);
					xhr.send();

					xhr.onloadend = function() {
						if (xhr.status == 200) {
							token = token_;
							getInfo();
						} else {
							print("Invalid Token.");
						}
					}
				} else if (input.value.startsWith("!") === false) {
					sendMessage();
				} else {
					return print("Invalid Command.");
				};
			};

			input.addEventListener("keydown", function (e) {
				if (e.key === "Enter") {
					validate();
				};
			});
		</script>
	</body>
</html>